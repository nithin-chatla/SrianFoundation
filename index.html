<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srian Foundation - Professional Donation Website</title>

    <!-- Tailwind CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <style>
        :root {
            --background-main: #fdfcfa;
            --background-alt: #f8fafc; /* gray-50 */
            --background-card: #ffffff;
            --text-primary: #1f2937;   /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --primary: #2563eb;       /* blue-600 */
            --accent: #D4AF37;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-main);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        html { scroll-behavior: smooth; }
        .gold-text { color: var(--accent); }
        
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-main);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #app-shell {
            opacity: 0; /* Initially hidden */
        }

        /* Input focus style */
        input:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary);
            border-color: var(--primary);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--background-card); 
            padding: 2rem;
            border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center; max-width: 90%; width: 400px;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }

        /* Live Ticker Styles */
        .live-ticker {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 30;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Consistent Section Padding */
        .section-padding {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        
        /* Card Hover Effect */
        .hover-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hover-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Gallery Item Hover */
        .gallery-item {
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .gallery-item img {
            transition: transform 0.4s ease;
        }
        .gallery-item:hover img {
            transform: scale(1.1) rotate(2deg);
        }

        /* Theme Switcher */
        #theme-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--background-card);
            color: var(--text-primary);
            border: 1px solid var(--background-alt);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        #theme-switcher:hover {
            transform: scale(1.1);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <div id="preloader">
        <div class="spinner"></div>
    </div>

    <!-- App Shell: Header, Main Content, Footer -->
    <div id="app-shell">
        <header class="bg-[var(--background-card)]/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center p-4">
                <a href="#" data-page="home" class="nav-link flex items-center gap-2 text-2xl font-bold gold-text">
                    <img id="website-logo" src="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508" alt="Srian Foundation Logo" class="h-10 w-10 rounded-full">
                    <span class="text-[var(--text-primary)]">Srian Foundation</span>
                </a>
                <nav class="hidden md:flex space-x-6 items-center text-[var(--text-secondary)]">
                    <a href="#" data-page="home" class="nav-item hover:text-[var(--primary)] transition-colors">Home</a>
                    <a href="#" data-page="donors" class="nav-item hover:text-[var(--primary)] transition-colors">Our Donors</a>
                    <a href="#" data-page="gallery" class="nav-item hover:text-[var(--primary)] transition-colors">Gallery</a>
                    <a href="#" data-page="about" class="nav-item hover:text-[var(--primary)] transition-colors">About Us</a>
                    <a href="#" data-page="contact" class="nav-item bg-[var(--primary)] text-white px-4 py-2 rounded-full font-semibold shadow-md hover:opacity-90 transition-all duration-300">Contact</a>
                </nav>
                <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-[var(--text-secondary)] hover:bg-[var(--background-alt)]">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
            <div id="mobile-menu" class="hidden md:hidden bg-[var(--background-card)] border-t border-[var(--background-alt)]">
                <a href="#" data-page="home" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Home</a>
                <a href="#" data-page="donors" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Our Donors</a>
                <a href="#" data-page="gallery" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Gallery</a>
                <a href="#" data-page="about" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">About Us</a>
                <a href="#" data-page="contact" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Contact</a>
            </div>
        </header>

        <main id="main-content"></main>

        <footer class="bg-gray-800 text-gray-300">
            <div class="container mx-auto py-12 px-4 text-center">
                <h3 class="footer-item text-2xl font-bold gold-text">Srian Foundation</h3>
                <p class="footer-item mt-4 max-w-2xl mx-auto">Making the world a better place, one smile at a time.</p>
                <div id="social-links-container" class="footer-item flex justify-center space-x-6 mt-6">
                    <!-- Social media links will be rendered here -->
                </div>
                <div class="footer-item mt-8 border-t border-gray-700 pt-6">
                    <a href="#" data-page="admin" class="nav-link text-sm text-gray-400 hover:text-white">Admin Panel</a>
                </div>
                <p class="footer-item mt-6 text-sm">&copy; 2025 Srian Foundation. All Rights Reserved.</p>
            </div>
        </footer>
    </div>
    
    <!-- Live Donation Ticker -->
    <div id="live-ticker" class="live-ticker">
        <i class="fas fa-heart text-red-500 animate-pulse"></i>
        <p id="ticker-text" class="text-sm text-gray-700"></p>
    </div>

    <!-- Modal Container -->
    <div id="custom-modal" class="modal-backdrop">
        <div class="modal-content">
            <p id="modal-message" class="text-lg mb-6"></p>
            <div id="modal-buttons">
                <!-- Buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Theme Switcher -->
    <button id="theme-switcher" title="Cycle Themes">
        <i class="fas fa-palette"></i>
    </button>

    <!-- Page Templates -->
    <template id="template-home">
        <!-- Hero Section -->
        <section class="hero-section bg-gradient-to-br from-blue-50 to-yellow-50 relative overflow-hidden">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between section-padding px-4">
                <div class="md:w-1/2 z-10 text-center md:text-left">
                    <h1 class="hero-title text-4xl md:text-6xl font-extrabold text-[var(--text-primary)] leading-tight">
                        Your Kindness Writes Their Future ‚ú®
                    </h1>
                    <p class="hero-p mt-6 text-lg md:text-xl max-w-xl mx-auto md:mx-0 text-[var(--text-secondary)]">
                        For years, our community of supporters has been the driving force behind our mission to feed and educate. Join us in continuing this legacy of hope.
                    </p>
                    <div class="mt-10 hero-btn">
                        <a href="#donate-form-section" class="bg-[var(--accent)] text-white text-lg font-semibold px-8 py-4 rounded-full shadow-lg hover:scale-105 transform transition-transform inline-block">
                            Join Our Mission <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    </div>
                </div>
                <div class="md:w-1/2 mt-12 md:mt-0 z-10 hero-img">
                    <img id="hero-image" src="https://ik.imagekit.io/gmxabb1dm/Download%20Donation%20box%20and%20charity%20concept_%20Human%20hands%20putting%20money%20cash%20love%20and%20heart%20to%20donation%20box%20together%20helping%20doing%20charity%20vector%20illustration%20for%20free.jpeg?updatedAt=1753799288747" alt="A child studying happily" class="rounded-2xl shadow-2xl w-full" />
                </div>
            </div>
        </section>

        <!-- Our Mission Section -->
        <section class="section-padding bg-[var(--background-alt)] overflow-hidden">
            <div class="container mx-auto px-4 text-center">
                <div class="section-title">
                    <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">An Enduring Commitment üíñ</h2>
                    <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">
                        Our work is built on a simple principle: every act of kindness matters. We focus on two core pillars to create lasting change.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-12 max-w-4xl mx-auto">
                    <div class="mission-card hover-card bg-blue-50 p-8 rounded-2xl shadow-lg">
                        <i class="fas fa-utensils text-4xl text-blue-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Food for the Soul üç≤</h3>
                        <p class="text-gray-600 mt-2">Providing warm, nutritious meals to children and the homeless has always been at the heart of what we do.</p>
                    </div>
                    <div class="mission-card hover-card bg-yellow-50 p-8 rounded-2xl shadow-lg">
                        <i class="fas fa-graduation-cap text-4xl text-yellow-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Opening Doors Through Education üéì</h3>
                        <p class="text-gray-600 mt-2">We believe in the power of education to break the cycle of poverty and unlock a brighter future for intelligent students.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Testimonials Section -->
        <section id="testimonials-section" class="section-padding bg-[var(--background-card)] overflow-hidden"></section>

        <!-- Donation Form Section -->
        <section id="donate-form-section" class="section-padding bg-[var(--background-alt)] overflow-hidden"></section>
        
        <!-- Photo Gallery Preview Section -->
        <section id="gallery-preview-section" class="section-padding bg-[var(--background-card)] overflow-hidden"></section>

        <!-- Contact Section on Home Page -->
        <section id="home-contact-section" class="section-padding bg-[var(--background-alt)] overflow-hidden"></section>
    </template>

    <template id="template-donors">
        <div class="section-padding bg-[var(--background-alt)] min-h-screen overflow-hidden">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Our Wall of Heroes ‚≠ê</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">A heartfelt thank you to every single person who has contributed to our cause.</p>
                </div>
                
                <div id="top-donors-highlight" class="mb-20">
                    <!-- Top donors will be rendered here by JS -->
                </div>

                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-center text-[var(--text-primary)] mb-8 section-title">All Supporters</h2>
                    <div class="mb-8">
                        <input type="text" id="donor-search" placeholder="Search for a supporter..." class="p-3 border rounded-lg w-full transition bg-[var(--background-card)] text-[var(--text-primary)]" />
                    </div>
                    <div id="donors-list-container" class="bg-[var(--background-card)] rounded-2xl shadow-lg p-8">
                        <!-- Rest of the donors list will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-gallery">
        <div class="section-padding bg-[var(--background-card)] min-h-screen overflow-hidden">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Moments We Cherish üì∏</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">Moments of joy and hope, made possible by you.</p>
                </div>
                 <div class="max-w-xl mx-auto mb-12">
                    <input type="text" id="gallery-search" placeholder="Search by location..." class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" />
                </div>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Gallery images will be rendered here -->
                </div>
            </div>
        </div>
    </template>

    <template id="template-about">
        <div class="section-padding bg-[var(--background-card)] overflow-hidden">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">The Heart of Our Mission ‚ù§Ô∏è</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">Learn more about who we are and what we do.</p>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-12 md:gap-16">
                    <div class="w-full md:w-1/2 about-image">
                        <img id="about-image" src="https://ik.imagekit.io/gmxabb1dm/20250729_2013_Srian%20Foundation%20Poster_simple_compose_01k1ba5pqgfwgbs4gpbmyahk7r.png?updatedAt=1753800313508" alt="Our Team" class="rounded-lg shadow-xl w-full h-auto" />
                    </div>
                    <div class="w-full md:w-1/2 about-text">
                        <h2 class="text-3xl font-bold text-[var(--text-primary)] mb-4">Driven by Compassion</h2>
                        <p class="text-[var(--text-secondary)] mb-4">
                            Srian Foundation was founded on a simple yet powerful idea: that collective kindness can create profound change. We are a dedicated team of volunteers, social workers, and community leaders committed to uplifting underprivileged children and individuals.
                        </p>
                        <p class="text-[var(--text-secondary)]">
                            Our mission is to ensure that no child goes hungry and every child has access to quality education. We create transparent, impactful programs that connect generous donors with those who need it most.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-contact">
        <div class="section-padding bg-[var(--background-alt)] overflow-hidden">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Let's Connect ü§ù</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">We'd love to hear from you. Send us a message below.</p>
                </div>
                <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg contact-form-container">
                    <form action="https://formspree.io/f/xldlnvrv" method="POST" class="space-y-6">
                        <div>
                            <label for="contact-email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email:</label>
                            <input type="email" id="contact-email" name="email" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                        </div>
                        <div>
                            <label for="message" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Message:</label>
                            <textarea id="message" name="message" rows="4" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-3 rounded-full shadow-lg w-full hover:opacity-90 transition-colors">
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-admin">
        <div class="section-padding bg-gray-100 min-h-screen">
            <div id="admin-view-container">
                <!-- Admin Login or Dashboard will be rendered here -->
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State & Elements ---
        const mainContent = document.getElementById('main-content');
        const appShell = document.getElementById('app-shell');
        const preloader = document.getElementById('preloader');
        let db, auth;
        let currentUser = null;
        let currentPageUnsubscribe = null; // Variable to hold the unsubscribe function
        
        // --- GSAP Plugin Registration ---
        gsap.registerPlugin(ScrollTrigger);

        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = "dugnv4zww";
        const CLOUDINARY_UPLOAD_PRESET = "Donation";

        // --- Modal Logic ---
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        const showModal = (message, content = '') => {
            modalMessage.textContent = message;
            modalButtons.innerHTML = content + `<button id="modal-close-button" class="bg-[var(--primary)] text-white font-semibold px-6 py-2 rounded-full hover:opacity-90 transition-colors">Close</button>`;
            modal.classList.add('visible');
            document.getElementById('modal-close-button').addEventListener('click', hideModal);
        };

        const hideModal = () => {
            modal.classList.remove('visible');
        };
        
        const showConfirmModal = (message) => {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modalButtons.innerHTML = `
                    <button id="modal-confirm-btn" class="bg-red-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-red-700 transition-colors mr-4">Delete</button>
                    <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-semibold px-6 py-2 rounded-full hover:bg-gray-400 transition-colors">Cancel</button>
                `;
                modal.classList.add('visible');

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                const close = (value) => {
                    hideModal();
                    resolve(value);
                };

                confirmBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false);
            });
        };

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if(document.getElementById('modal-cancel-btn')) {
                     document.getElementById('modal-cancel-btn').click();
                } else {
                     hideModal();
                }
            }
        });
        
        // --- Helper Functions ---
        const uploadImageCloudinary = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    // SPEED OPTIMIZATION: Add Cloudinary auto-format and auto-quality transformations
                    const urlParts = data.secure_url.split('/upload/');
                    const optimizedUrl = `${urlParts[0]}/upload/f_auto,q_auto/${urlParts[1]}`;
                    return optimizedUrl;
                } else {
                    throw new Error('Image upload failed.');
                }
            } catch (error) {
                console.error('Cloudinary Upload Error:', error);
                throw error;
            }
        };

        // --- Reusable Component Renderers ---
        const renderDonationForm = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Pledge Your Support üôè</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Fill out the form below and we will contact you to complete your donation.</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg mt-12 donation-form-container">
                        <form id="donation-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="name" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Name</label>
                                    <input type="text" name="name" id="name" placeholder="John Doe" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email</label>
                                    <input type="email" name="email" id="email" placeholder="john.doe@example.com" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="phone" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Phone Number</label>
                                    <input type="tel" name="phone" id="phone" placeholder="Your phone number" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="amount" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Pledge Amount (INR)</label>
                                    <input type="number" name="amount" id="amount" placeholder="e.g., 5000" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                            </div>
                            <div class="text-center pt-4">
                                <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-4 rounded-full shadow-lg w-full hover:opacity-90 transition-colors disabled:bg-gray-400">
                                    Submit Pledge
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            const form = container.querySelector('#donation-form');
            form.addEventListener('submit', handleDonationSubmit);
        };
        
        const renderTestimonials = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Voices from Our Community üì£</h2>
                    </div>
                    <div id="testimonials-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12">
                        <!-- Mock Testimonials for Demo -->
                        <div class="testimonial-card hover-card bg-[var(--background-alt)] p-8 rounded-2xl shadow-lg">
                            <p class="text-[var(--text-secondary)] italic">"The transparency and impact of Srian Foundation are truly remarkable. It's a privilege to be a part of this community."</p>
                            <p class="font-bold text-[var(--text-primary)] mt-4">- Priya Sharma</p>
                        </div>
                         <div class="testimonial-card hover-card bg-[var(--background-alt)] p-8 rounded-2xl shadow-lg">
                            <p class="text-[var(--text-secondary)] italic">"Seeing the smiles on the children's faces makes every contribution worthwhile. Thank you for your incredible work!"</p>
                            <p class="font-bold text-[var(--text-primary)] mt-4">- Rohan Gupta</p>
                        </div>
                         <div class="testimonial-card hover-card bg-[var(--background-alt)] p-8 rounded-2xl shadow-lg">
                            <p class="text-[var(--text-secondary)] italic">"A fantastic organization that genuinely makes a difference. Their dedication to education is inspiring."</p>
                            <p class="font-bold text-[var(--text-primary)] mt-4">- Anjali Mehta</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGalleryPreview = (container) => {
             const galleryImages = [
                'https://picsum.photos/seed/event1/400/400', 'https://picsum.photos/seed/event2/400/400',
                'https://picsum.photos/seed/event3/400/400', 'https://picsum.photos/seed/event4/400/400',
            ];
            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">A Glimpse of the Smiles You Create üòä</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Moments from our food distribution and education support events.</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-12 gallery-preview-grid">
                        ${galleryImages.map(src => `<div class="gallery-item rounded-lg shadow-md"><img src="${src}" class="w-full h-full object-cover" /></div>`).join('')}
                    </div>
                    <div class="text-center mt-12">
                        <a href="#" data-page="gallery" class="nav-link bg-[var(--primary)] text-white font-semibold px-8 py-3 rounded-full hover:opacity-90 transition-colors">
                            View Full Gallery
                        </a>
                    </div>
                </div>
            `;
            container.querySelector('.nav-link').addEventListener('click', handleNavClick);
        };

        const renderContactSection = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 section-title">
                        <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Let's Connect ü§ù</h1>
                        <p class="mt-4 text-lg text-[var(--text-secondary)]">We'd love to hear from you. Send us a message below.</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg contact-form-container">
                        <form action="https://formspree.io/f/xldlnvrv" method="POST" class="space-y-6">
                            <div>
                                <label for="home-contact-email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email:</label>
                                <input type="email" id="home-contact-email" name="email" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                            </div>
                            <div>
                                <label for="home-message" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Message:</label>
                                <textarea id="home-message" name="message" rows="4" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required></textarea>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-3 rounded-full shadow-lg w-full hover:opacity-90 transition-colors">
                                    Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };
        
        // --- Animation Functions ---
        const animateOnScroll = (selector, from, to) => {
            gsap.fromTo(selector, from, {
                ...to,
                scrollTrigger: {
                    trigger: selector,
                    start: 'top 85%',
                    toggleActions: 'play none none none',
                },
            });
        };
        
        const runPageAnimations = (page) => {
            // Default fade-in for section titles
            document.querySelectorAll('.section-title').forEach(el => {
                animateOnScroll(el, { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' });
            });

            if (page === 'home') {
                gsap.from('.hero-title', { opacity: 0, y: 30, duration: 1, ease: 'power3.out', delay: 0.2 });
                gsap.from('.hero-p', { opacity: 0, y: 30, duration: 1, ease: 'power3.out', delay: 0.4 });
                gsap.from('.hero-btn', { opacity: 0, scale: 0.8, duration: 1, ease: 'elastic.out(1, 0.5)', delay: 0.6 });
                gsap.from('.hero-img', { opacity: 0, scale: 1.1, duration: 1.2, ease: 'power3.out', delay: 0.3 });

                document.querySelectorAll('.mission-card').forEach((card, index) => {
                    animateOnScroll(card, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', delay: index * 0.2 });
                });
                document.querySelectorAll('.testimonial-card').forEach((card, index) => {
                    animateOnScroll(card, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', delay: index * 0.2 });
                });
                document.querySelectorAll('.gallery-preview-grid .gallery-item').forEach((img, index) => {
                    animateOnScroll(img, { opacity: 0, scale: 0.8 }, { opacity: 1, scale: 1, duration: 0.8, ease: 'power3.out', delay: index * 0.1 });
                });
                 animateOnScroll('.donation-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
                 animateOnScroll('#home-contact-section .contact-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
            }
            
            if (page === 'gallery') {
                 document.querySelectorAll('.gallery-item').forEach((item) => {
                    animateOnScroll(item, { opacity: 0, scale: 0.8, y: 30 }, { opacity: 1, scale: 1, y: 0, duration: 0.6, ease: 'power3.out', stagger: 0.05 });
                });
            }
            
            if (page === 'about') {
                animateOnScroll('.about-image', { opacity: 0, x: -50 }, { opacity: 1, x: 0, duration: 1, ease: 'power3.out' });
                animateOnScroll('.about-text', { opacity: 0, x: 50 }, { opacity: 1, x: 0, duration: 1, ease: 'power3.out' });
            }
            
             if (page === 'contact') {
                animateOnScroll('.contact-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
            }
        };


        // --- Page Render Functions ---
        const pages = {
            home: () => {
                const template = document.getElementById('template-home');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                renderTestimonials(mainContent.querySelector('#testimonials-section'));
                renderDonationForm(mainContent.querySelector('#donate-form-section'));
                renderGalleryPreview(mainContent.querySelector('#gallery-preview-section'));
                renderContactSection(mainContent.querySelector('#home-contact-section'));
                mainContent.querySelectorAll('.nav-link, .nav-item').forEach(link => link.addEventListener('click', handleNavClick));
            },
            donors: () => {
                const template = document.getElementById('template-donors');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const topDonorsContainer = mainContent.querySelector('#top-donors-highlight');
                const restOfDonorsContainer = mainContent.querySelector('#donors-list-container');
                let allDonors = [];

                const renderTopDonors = (topThree) => {
                    if (!topDonorsContainer) return;
                    if (topThree.length === 0) {
                        topDonorsContainer.innerHTML = '';
                        return;
                    }
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    
                    let orderedTopThree = [...topThree];
                    if (topThree.length > 1) {
                        orderedTopThree = [topThree[1], topThree[0], ...topThree.slice(2)];
                    }

                    topDonorsContainer.innerHTML = `
                        <h2 class="text-3xl font-bold text-center text-[var(--text-primary)] mb-8 section-title">Our Top Supporters</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                            ${orderedTopThree.map((donor, index) => {
                                const originalIndex = topThree.indexOf(donor);
                                const initials = donor.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                                const imageSrc = donor.imageUrl || `https://placehold.co/128x128/E0E7FF/3730A3?text=${initials}`;
                                const scaleClass = originalIndex === 0 ? 'md:scale-110' : '';
                                const medal = medals[originalIndex];

                                return `
                                    <div class="top-donor-card hover-card bg-[var(--background-card)] p-6 rounded-2xl shadow-lg text-center ${scaleClass}">
                                        <div class="relative inline-block">
                                            <img src="${imageSrc}" alt="${donor.name}" class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-md object-cover" />
                                            <span class="absolute -top-2 -right-2 text-4xl">${medal}</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mt-4 text-[var(--text-primary)]">${donor.name}</h3>
                                        <p class="text-lg font-semibold gold-text mt-1">‚Çπ${donor.amount.toLocaleString('en-IN')}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                };

                const renderDonorList = (donorsToRender) => {
                    if (!restOfDonorsContainer) return;
                    if (donorsToRender.length === 0) {
                        restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">No other donors found.</p>`;
                        return;
                    }
                    restOfDonorsContainer.innerHTML = `<div class="space-y-4">${donorsToRender.map((donor) => {
                        const date = donor.timestamp ? new Date(donor.timestamp.toDate()).toLocaleDateString() : 'N/A';
                        const initials = donor.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                        const imageSrc = donor.imageUrl || `https://placehold.co/48x48/E0E7FF/3730A3?text=${initials}`;
                        
                        return `
                            <div class="donor-list-item flex items-center justify-between p-4 bg-[var(--background-alt)] rounded-lg">
                                <div class="flex items-center gap-4">
                                    <img src="${imageSrc}" alt="${donor.name}" class="w-12 h-12 rounded-full object-cover" />
                                    <div>
                                        <p class="font-semibold text-[var(--text-primary)]">${donor.name}</p>
                                        <p class="text-sm text-[var(--text-secondary)]">${donor.location}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg gold-text">‚Çπ${donor.amount.toLocaleString('en-IN')}</p>
                                    <p class="text-xs text-gray-400">${date}</p>
                                </div>
                            </div>`;
                    }).join('')}</div>`;

                    gsap.from(".donor-list-item", {
                        duration: 0.5,
                        opacity: 0,
                        y: 20,
                        stagger: 0.05,
                        ease: "power3.out"
                    });
                };

                const searchInput = document.getElementById('donor-search');
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredDonors = allDonors.filter(donor => donor.name.toLowerCase().includes(searchTerm));
                    renderDonorList(filteredDonors);
                });

                restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">Loading donors...</p>`;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const q = query(collection(db, donationsCollectionPath));

                currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        topDonorsContainer.innerHTML = '';
                        restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">No donations yet. Be the first!</p>`;
                        return;
                    }
                    
                    let fullDonorList = snapshot.docs.map(doc => doc.data());
                    fullDonorList.sort((a, b) => b.amount - a.amount);
                    
                    const topThree = fullDonorList.slice(0, 3);
                    allDonors = fullDonorList.slice(3);
                    
                    renderTopDonors(topThree);
                    renderDonorList(allDonors);
                    runPageAnimations('donors');
                });
            },
            gallery: () => {
                const template = document.getElementById('template-gallery');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const galleryGrid = mainContent.querySelector('#gallery-grid');
                galleryGrid.innerHTML = `<p class="text-center text-[var(--text-secondary)] col-span-full">Loading gallery...</p>`;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
                const q = query(collection(db, galleryCollectionPath));

                currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        galleryGrid.innerHTML = `<p class="text-center text-[var(--text-secondary)] col-span-full">No images in the gallery yet.</p>`;
                        return;
                    }
                    galleryGrid.innerHTML = snapshot.docs.map(doc => {
                        const image = doc.data();
                        return `<div class="gallery-item shadow-md"><img src="${image.imageUrl}" class="w-full h-full object-cover" /></div>`
                    }).join('');
                    runPageAnimations('gallery');
                });
            },
            about: () => {
                const template = document.getElementById('template-about');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
            },
            contact: () => {
                const template = document.getElementById('template-contact');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
            },
            admin: async () => {
                const template = document.getElementById('template-admin');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const container = mainContent.querySelector('#admin-view-container');
                
                if (currentUser && !currentUser.isAnonymous && await isAdmin(currentUser.email)) {
                    renderAdminDashboard(container, currentUser);
                } else {
                    renderAdminLogin(container);
                }
            }
        };

        const isAdmin = async (email) => {
            if (!email) return false;
            try {
                const adminDocRef = doc(db, "admins", email);
                const adminDoc = await getDoc(adminDocRef);
                return adminDoc.exists();
            } catch (error) {
                console.error("Error checking admin status:", error);
                return false;
            }
        };

        const renderAdminLogin = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4 max-w-md">
                    <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">Admin Login</h1>
                        <p class="text-gray-600 mb-6">Please sign in with an authorized Google account to access the dashboard.</p>
                        <button id="admin-google-login-btn" class="bg-white text-gray-700 font-semibold px-6 py-3 rounded-full w-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center gap-3">
                            <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-5 h-5" />
                            Sign in with Google
                        </button>
                    </div>
                </div>
            `;
            container.querySelector('#admin-google-login-btn').addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const userIsAdmin = await isAdmin(result.user.email);
                    if (!userIsAdmin) {
                        await signOut(auth);
                        showModal('Access Denied. This Google account is not authorized.');
                    } else {
                        navigateTo('admin');
                    }
                } catch (error) {
                    showModal('Login Failed: ' + error.message);
                }
            });
        };
        
        const renderAdminDashboard = (container, user) => {
            container.innerHTML = `
                <div class="container mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-12 gap-4">
                        <h1 class="text-4xl font-bold text-gray-800">Admin Dashboard</h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">Welcome, ${user.displayName || user.email}</span>
                            <button id="admin-logout-btn" class="bg-red-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-600">Sign Out</button>
                        </div>
                    </div>
                    
                    <!-- Manage Logo Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Logo</h2>
                        <form id="logo-form" class="space-y-4">
                            <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" required />
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-indigo-700 disabled:bg-gray-400">Upload New Logo</button>
                        </form>
                    </div>

                    <!-- Manage Pledges Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Pledges</h2>
                        <div id="admin-pledges-list" class="max-h-96 overflow-y-auto"></div>
                    </div>

                    <!-- Manage Donors Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Donors</h2>
                        <div class="mb-4">
                            <input type="text" id="admin-donor-search" placeholder="Search donors..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-donors-list" class="max-h-96 overflow-y-auto mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add New Donor</h3>
                        <form id="add-donor-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="name" placeholder="Donor Name" class="p-3 border rounded-lg w-full" required />
                                <input type="number" name="amount" placeholder="Amount" class="p-3 border rounded-lg w-full" required />
                                <input type="text" name="location" placeholder="Location" class="p-3 border rounded-lg w-full" required />
                                <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" />
                                <input type="email" name="email" placeholder="Donor Email" class="p-3 border rounded-lg w-full" />
                                <input type="tel" name="phone" placeholder="Donor Phone" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-blue-700 disabled:bg-gray-400">Add Donor</button>
                        </form>
                    </div>

                    <!-- Manage Gallery Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Gallery</h2>
                         <div class="mb-4">
                            <input type="text" id="admin-gallery-search" placeholder="Search by location..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-gallery-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add Gallery Image</h3>
                        <form id="add-gallery-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" required />
                                <input type="text" name="location" placeholder="Location (e.g., Hyderabad)" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-green-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-green-600 disabled:bg-gray-400">Add to Gallery</button>
                        </form>
                    </div>

                    <!-- Manage Content Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Website Content</h2>
                        <form id="content-form" class="space-y-6">
                            <!-- Hero Section -->
                            <div class="pb-6 border-b">
                                <h3 class="text-xl font-semibold mb-2">Homepage Hero Section</h3>
                                <input type="text" name="heroTitle" placeholder="Hero Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="heroSubtitle" placeholder="Hero Subtitle" class="p-3 border rounded-lg w-full h-24"></textarea>
                            </div>
                            <!-- Mission Section -->
                            <div class="pb-6 border-b">
                                <h3 class="text-xl font-semibold mb-2">Homepage Mission Section</h3>
                                <input type="text" name="missionTitle" placeholder="Mission Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="missionSubtitle" placeholder="Mission Subtitle" class="p-3 border rounded-lg w-full h-24 mb-4"></textarea>
                                <input type="text" name="pillar1Title" placeholder="Pillar 1 Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="pillar1Text" placeholder="Pillar 1 Text" class="p-3 border rounded-lg w-full h-20 mb-4"></textarea>
                                <input type="text" name="pillar2Title" placeholder="Pillar 2 Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="pillar2Text" placeholder="Pillar 2 Text" class="p-3 border rounded-lg w-full h-20"></textarea>
                            </div>
                            <!-- Social Links -->
                            <div>
                                <h3 class="text-xl font-semibold mb-2">Social Media Links</h3>
                                <input type="url" name="facebook" placeholder="Facebook URL" class="p-3 border rounded-lg w-full mb-2" />
                                <input type="url" name="twitter" placeholder="Twitter URL" class="p-3 border rounded-lg w-full mb-2" />
                                <input type="url" name="instagram" placeholder="Instagram URL" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-purple-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-purple-700">Save All Content</button>
                        </form>
                    </div>
                </div>
            `;
            container.querySelector('#admin-logout-btn').addEventListener('click', () => signOut(auth));
            
            // Add Logo Form Logic
            container.querySelector('#logo-form').addEventListener('submit', handleLogoUpload);
            
            // Add Donor Form Logic
            container.querySelector('#add-donor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const imageFile = form.imageFile.files[0];

                try {
                    const imageUrl = await uploadImageCloudinary(imageFile);
                    await addDoc(collection(db, donationsCollectionPath), {
                        name: form.name.value,
                        amount: Number(form.amount.value),
                        location: form.location.value,
                        email: form.email.value,
                        phone: form.phone.value,
                        imageUrl: imageUrl,
                        timestamp: new Date()
                    });
                    showModal('Donor added successfully!');
                    form.reset();
                } catch (error) {
                    showModal('Error adding donor: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add Donor';
                }
            });

            // Add Gallery Form Logic
            container.querySelector('#add-gallery-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
                const imageFile = form.imageFile.files[0];

                try {
                    const imageUrl = await uploadImageCloudinary(imageFile);
                    await addDoc(collection(db, galleryCollectionPath), {
                        imageUrl: imageUrl,
                        location: form.location.value,
                        createdAt: new Date()
                    });
                    showModal('Image added to gallery!');
                    form.reset();
                } catch (error) {
                    showModal('Error adding image: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add to Gallery';
                }
            });

            // Content Form Logic
            container.querySelector('#content-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const content = {
                    heroTitle: form.heroTitle.value,
                    heroSubtitle: form.heroSubtitle.value,
                    missionTitle: form.missionTitle.value,
                    missionSubtitle: form.missionSubtitle.value,
                    pillar1Title: form.pillar1Title.value,
                    pillar1Text: form.pillar1Text.value,
                    pillar2Title: form.pillar2Title.value,
                    pillar2Text: form.pillar2Text.value,
                };
                const socialLinks = {
                    facebook: form.facebook.value,
                    twitter: form.twitter.value,
                    instagram: form.instagram.value,
                };
                
                try {
                    await setDoc(doc(db, "settings", "content"), content, { merge: true });
                    await setDoc(doc(db, "settings", "socialLinks"), socialLinks, { merge: true });
                    showModal('Website content updated successfully!');
                } catch (error) {
                    showModal('Error updating content: ' + error.message);
                }
            });
            
            // Load initial data for the dashboard
            loadAdminDonorsList();
            loadAdminGalleryList();
            loadAdminPledgesList();
            loadAdminContentForm();
        };

        const loadAdminDonorsList = () => {
            const container = document.getElementById('admin-donors-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading donors...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
            const q = query(collection(db, donationsCollectionPath));
            let allDonors = [];

            const renderTable = (donors) => {
                 if (donors.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No donors found.</p>`;
                    return;
                }
                container.innerHTML = `<table class="w-full text-left text-sm">
                    <thead>
                        <tr class="border-b">
                            <th class="p-2">Name</th><th class="p-2">Amount</th><th class="p-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${donors.map(doc => {
                        const donor = doc.data();
                        return `
                        <tr class="border-b border-gray-100">
                            <td class="p-2">${donor.name}</td>
                            <td class="p-2">‚Çπ${donor.amount.toLocaleString('en-IN')}</td>
                            <td class="p-2">
                                <button data-id="${doc.id}" class="delete-donor-btn text-red-500 hover:text-red-700">Delete</button>
                            </td>
                        </tr>`;
                    }).join('')}
                    </tbody>
                </table>`;

                document.querySelectorAll('.delete-donor-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this donor? This action cannot be undone.');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, donationsCollectionPath, docId));
                                showModal('Donor deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting donor: ' + error.message);
                            }
                        }
                    });
                });
            };

            const searchInput = document.getElementById('admin-donor-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredDonors = allDonors.filter(doc => doc.data().name.toLowerCase().includes(searchTerm));
                renderTable(filteredDonors);
            });

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                allDonors = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp);
                renderTable(allDonors);
            });
        };
        
        const loadAdminGalleryList = () => {
            const container = document.getElementById('admin-gallery-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500 col-span-full">Loading gallery...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
            const q = query(collection(db, galleryCollectionPath));
            let allImages = [];

            const renderGrid = (images) => {
                if (images.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 col-span-full">No images found.</p>`;
                    return;
                }
                container.innerHTML = images.map(doc => {
                    const image = doc.data();
                    return `
                        <div class="relative group">
                            <img src="${image.imageUrl}" class="rounded-lg shadow-md w-full h-full object-cover" />
                            <button data-id="${doc.id}" class="delete-gallery-btn absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.delete-gallery-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this image? This action cannot be undone.');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, galleryCollectionPath, docId));
                                showModal('Image deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting image: ' + error.message);
                            }
                        }
                    });
                });
            };
            
            const searchInput = document.getElementById('admin-gallery-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredImages = allImages.filter(doc => doc.data().location && doc.data().location.toLowerCase().includes(searchTerm));
                renderGrid(filteredImages);
            });

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                allImages = snapshot.docs.sort((a, b) => b.data().createdAt - a.data().createdAt);
                renderGrid(allImages);
            });
        };
        
        const loadAdminPledgesList = () => {
            const container = document.getElementById('admin-pledges-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading pledges...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const pledgesCollectionPath = `/artifacts/${appId}/public/data/pledges`;
            const q = query(collection(db, pledgesCollectionPath));

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500">No pledges yet.</p>`;
                    return;
                }
                const sortedDocs = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp);
                container.innerHTML = `<table class="w-full text-left text-sm">
                    <thead>
                        <tr class="border-b">
                            <th class="p-2">Name</th><th class="p-2">Phone</th><th class="p-2">Amount</th><th class="p-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${sortedDocs.map(doc => {
                        const pledge = doc.data();
                        return `
                        <tr class="border-b border-gray-100">
                            <td class="p-2">${pledge.name}</td>
                            <td class="p-2">${pledge.phone}</td>
                            <td class="p-2">‚Çπ${pledge.amount.toLocaleString('en-IN')}</td>
                            <td class="p-2">
                                <button data-id="${doc.id}" class="delete-pledge-btn text-red-500 hover:text-red-700">Delete</button>
                            </td>
                        </tr>`;
                    }).join('')}
                    </tbody>
                </table>`;

                document.querySelectorAll('.delete-pledge-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this pledge?');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, pledgesCollectionPath, docId));
                                showModal('Pledge deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting pledge: ' + error.message);
                            }
                        }
                    });
                });
            });
        };

        const loadAdminContentForm = async () => {
            const form = document.getElementById('content-form');
            if (!form) return;

            const contentRef = doc(db, "settings", "content");
            const socialLinksRef = doc(db, "settings", "socialLinks");

            const contentSnap = await getDoc(contentRef);
            const socialLinksSnap = await getDoc(socialLinksRef);

            if (contentSnap.exists()) {
                const data = contentSnap.data();
                form.heroTitle.value = data.heroTitle || '';
                form.heroSubtitle.value = data.heroSubtitle || '';
                form.missionTitle.value = data.missionTitle || '';
                form.missionSubtitle.value = data.missionSubtitle || '';
                form.pillar1Title.value = data.pillar1Title || '';
                form.pillar1Text.value = data.pillar1Text || '';
                form.pillar2Title.value = data.pillar2Title || '';
                form.pillar2Text.value = data.pillar2Text || '';
            }

            if (socialLinksSnap.exists()) {
                const data = socialLinksSnap.data();
                form.facebook.value = data.facebook || '';
                form.twitter.value = data.twitter || '';
                form.instagram.value = data.instagram || '';
            }
        };

        // --- Event Handlers ---
        const handleNavClick = (e) => {
            e.preventDefault();
            const page = e.currentTarget.dataset.page;
            navigateTo(page);
        };

        const handleDonationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

            const name = form.name.value;
            const amount = form.amount.value;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const pledgesCollectionPath = `/artifacts/${appId}/public/data/pledges`;
                await addDoc(collection(db, pledgesCollectionPath), {
                    name: name,
                    email: form.email.value,
                    phone: form.phone.value,
                    amount: Number(amount),
                    timestamp: new Date()
                });
                
                const thankYouContent = `
                    <div id="gemini-thank-you" class="mt-4 text-left">
                        <button id="generate-note-btn" class="bg-yellow-400 text-yellow-900 font-semibold px-4 py-2 rounded-full w-full mb-4 hover:bg-yellow-500 transition-colors">
                            ‚ú® Generate a Personalized Thank You Note
                        </button>
                        <div id="note-container" class="hidden">
                             <textarea id="thank-you-note" class="w-full h-32 p-2 border rounded-lg bg-[var(--background-alt)] text-[var(--text-secondary)]" readonly></textarea>
                             <button id="copy-note-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-1 rounded-full mt-2 text-sm hover:bg-gray-300">Copy</button>
                        </div>
                        <div id="loading-spinner" class="hidden justify-center items-center p-4"><div class="spinner"></div></div>
                    </div>
                `;
                showModal('Thank you for your pledge! We will contact you shortly.', thankYouContent);
                
                document.getElementById('generate-note-btn').addEventListener('click', () => generateThankYouNote(name, amount));

                form.reset();
            } catch (error) {
                console.error("Error adding pledge: ", error);
                showModal('There was an error submitting your pledge. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Submit Pledge';
            }
        };
        
        const handleLogoUpload = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button');
            const file = form.imageFile.files[0];
            if (!file) {
                showModal("Please select a file to upload.");
                return;
            }

            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const imageUrl = await uploadImageCloudinary(file);
                await setDoc(doc(db, "settings", "logo"), { url: imageUrl });
                showModal("Logo updated successfully!");
            } catch (error) {
                showModal("Error uploading logo: " + error.message);
            } finally {
                button.disabled = false;
                button.textContent = "Upload New Logo";
                form.reset();
            }
        };
        
        // --- Router ---
        const navigateTo = async (page) => {
            // Detach any active Firestore listeners from the previous page
            if (typeof currentPageUnsubscribe === 'function') {
                currentPageUnsubscribe();
                currentPageUnsubscribe = null;
            }
            
            window.scrollTo(0, 0);
            
            if (pages[page]) {
                await pages[page]();
            } else {
                await pages.home(); // Default to home
            }
            
            // Wait a moment for content to be in DOM, then run animations
            setTimeout(() => {
                runPageAnimations(page);
            }, 100);
        };

        // --- Theme Management ---
        const themes = {
            light: {
                '--background-main': '#fdfcfa',
                '--background-alt': '#f8fafc',
                '--background-card': '#ffffff',
                '--text-primary': '#1f2937',
                '--text-secondary': '#4b5563',
                '--primary': '#2563eb',
                '--accent': '#D4AF37',
            },
            dark: {
                '--background-main': '#111827',
                '--background-alt': '#1f2937',
                '--background-card': '#374151',
                '--text-primary': '#f9fafb',
                '--text-secondary': '#d1d5db',
                '--primary': '#3b82f6',
                '--accent': '#FBBF24',
            },
            serene: {
                '--background-main': '#f0fdf4',
                '--background-alt': '#dcfce7',
                '--background-card': '#ffffff',
                '--text-primary': '#14532d',
                '--text-secondary': '#166534',
                '--primary': '#22c55e',
                '--accent': '#f97316',
            }
        };
        let currentThemeIndex = 0;
        const themeNames = Object.keys(themes);

        const applyTheme = (themeName) => {
            const theme = themes[themeName];
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
            localStorage.setItem('srian-theme', themeName);
        };

        const cycleTheme = () => {
            currentThemeIndex = (currentThemeIndex + 1) % themeNames.length;
            const newThemeName = themeNames[currentThemeIndex];
            applyTheme(newThemeName);
        };

        // --- Social Links ---
        const renderSocialLinks = async () => {
            const container = document.getElementById('social-links-container');
            if (!container) return;
            
            // Using mock data for now, can be replaced with Firestore fetch
            const socialLinks = {
                facebook: "https://facebook.com",
                twitter: "https://twitter.com",
                instagram: "https://instagram.com"
            };

            let html = '';
            if (socialLinks.facebook) {
                html += `<a href="${socialLinks.facebook}" target="_blank" class="text-2xl hover:text-blue-500 transition-colors"><i class="fab fa-facebook-f"></i></a>`;
            }
            if (socialLinks.twitter) {
                html += `<a href="${socialLinks.twitter}" target="_blank" class="text-2xl hover:text-blue-400 transition-colors"><i class="fab fa-twitter"></i></a>`;
            }
            if (socialLinks.instagram) {
                html += `<a href="${socialLinks.instagram}" target="_blank" class="text-2xl hover:text-pink-500 transition-colors"><i class="fab fa-instagram"></i></a>`;
            }
            container.innerHTML = html;
        };

        // --- Gemini API Feature ---
        const generateThankYouNote = async (name, amount) => {
            const generateBtn = document.getElementById('generate-note-btn');
            const noteContainer = document.getElementById('note-container');
            const noteTextarea = document.getElementById('thank-you-note');
            const loadingSpinner = document.getElementById('loading-spinner');

            generateBtn.style.display = 'none';
            loadingSpinner.style.display = 'flex';

            const prompt = `Generate a short, heartfelt thank you message for a donation to our charity, the Srian Foundation. The donor's name is ${name} and they pledged ‚Çπ${amount}. Mention our work with feeding and educating children. Keep it under 50 words and sign it from 'The Srian Foundation Team'.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    noteTextarea.value = text;
                    noteContainer.style.display = 'block';

                    document.getElementById('copy-note-btn').addEventListener('click', () => {
                        noteTextarea.select();
                        document.execCommand('copy');
                        showModal("Copied to clipboard!");
                    });
                } else {
                    throw new Error("No content generated.");
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                noteTextarea.value = "Sorry, we couldn't generate a message at this time. But please know we are incredibly grateful for your support!";
                noteContainer.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        };
        
        const loadLogo = () => {
            const logoEl = document.getElementById('website-logo');
            if (!logoEl) return;
            const logoRef = doc(db, "settings", "logo");
            onSnapshot(logoRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().url) {
                    logoEl.src = docSnap.data().url;
                }
            });
        };


        // --- App Initialization ---
        const initApp = async () => {
            // Setup mobile menu
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            
            // Attach nav link listeners
            document.querySelectorAll('.nav-link, .nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    handleNavClick(e);
                    mobileMenu.classList.add('hidden'); // Close menu on navigation
                });
            });

            // Setup Theme Switcher
            const savedTheme = localStorage.getItem('srian-theme') || 'light';
            currentThemeIndex = themeNames.indexOf(savedTheme);
            applyTheme(savedTheme);
            document.getElementById('theme-switcher').addEventListener('click', cycleTheme);

            // Firebase setup
            const firebaseConfig = {
                apiKey: "AIzaSyAjYZKpRhp_4SyJuAP5nHzrUkgnsdjg2sc",
                authDomain: "sharethejoy-donations.firebaseapp.com",
                projectId: "sharethejoy-donations",
                storageBucket: "sharethejoy-donations.appspot.com",
                messagingSenderId: "791267759945",
                appId: "1:791267759945:web:b769b5ba8c30bdec9fac98",
                measurementId: "G-P1RZ0CNDPC"
            };
            
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('error'); // Set to 'debug' for development
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
            });

            try {
                await auth.authStateReady();
                
                // Fade out preloader and show app
                gsap.to(preloader, { 
                    duration: 0.5, 
                    opacity: 0, 
                    onComplete: () => preloader.style.display = 'none' 
                });
                gsap.to(appShell, { duration: 0.5, opacity: 1, delay: 0.2 });

                if (auth.currentUser === null) {
                    await signInAnonymously(auth);
                }
                console.log("Firebase base authentication successful.");
                
                // Initial page load
                loadLogo();
                pages.home();
                runPageAnimations('home');
                renderSocialLinks();
                
                // --- Initialize Live Features ---
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const q = query(collection(db, donationsCollectionPath));
                let recentDonations = [];
                
                onSnapshot(q, (snapshot) => {
                    const allDonations = [];
                    snapshot.forEach(doc => {
                        allDonations.push(doc.data());
                    });
                    
                    recentDonations = allDonations.sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);
                });

                // Live Ticker Logic
                const ticker = document.getElementById('live-ticker');
                const tickerText = document.getElementById('ticker-text');
                let tickerIndex = 0;
                setInterval(() => {
                    if (recentDonations.length > 0) {
                        ticker.style.display = 'flex';
                        const donation = recentDonations[tickerIndex];
                        tickerText.textContent = `${donation.name} from ${donation.location} just donated ‚Çπ${donation.amount.toLocaleString('en-IN')}!`;
                        gsap.fromTo(ticker, {opacity: 0, y: 20}, {opacity: 1, y: 0, duration: 0.5});
                        setTimeout(() => {
                           gsap.to(ticker, {opacity: 0, y: 20, duration: 0.5});
                        }, 4500);
                        tickerIndex = (tickerIndex + 1) % recentDonations.length;
                    }
                }, 5500);


            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showModal("Could not connect to the service. Please try again later.");
                mainContent.innerHTML = `<div class="text-center py-20"><p>Application failed to start.</p></div>`;
                preloader.style.display = 'none';
                appShell.style.opacity = 1;
            }

            // Animate footer on scroll
            gsap.from(".footer-item", {
                scrollTrigger: {
                    trigger: "footer",
                    start: "top 95%",
                },
                duration: 0.8,
                opacity: 0,
                y: 30,
                stagger: 0.15,
                ease: 'power3.out'
            });
        };

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
